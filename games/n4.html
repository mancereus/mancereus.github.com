<!doctype html>
<html>
<head>
  <title></title>
  <!--script src="http://www.polymer-project.org/polymer/polymer.min.min.js"></script-->
  <meta name="viewport"content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="lib/platform/platform.min.js"> </script>
  
</head>
<body>
 

  <polymer-element name="r-ruleset" >
  <template>
    <polymer-signals id="xx"></polymer-signals>
    <span>Im <b>r-ruleset</b>. This is my Shadow DOM.</span>
    <ul id="uu">
      <content></content>
    </ul>
  </template>
  <script>
   Polymer('r-ruleset', {
     ready: function() {
       console.log("r-ruleset ready ");
     },
     enteredView: function() {
       console.log("r-ruleset inserted");
     },
   });
 </script>
</polymer-element>

<polymer-element  name="r-variable" on-dragStart="{{dragStart}}"  on-drag="{{dragIt}}"  on-dragover="{{allowDrop}}" on-drop="{{dragStop}}"  attributes="type name guid">
<template>
  <polymer-signals id="xx" on-polymer-signal-foo="{{fooSignal}}"></polymer-signals>
  <span on-click={{showVariable}}><b>r-variable</b>. {{name}}.</span>
  <ul id="uu">
    <content></content>
  </ul>
</template>
<script>
// var draginfo="";
Polymer('r-variable', {
 dragged:false,
 ready: function() {
   console.log("r-variable ready ");
   
 },
 enteredView: function() {
   console.log("r-variable ", this.name, " inserted" );
   this.super( );
 },
 showVariable: function() {
   console.log("will show ", this.name, this.type);
   
 },
 dragStart: function(ev) {

  ev.dataTransfer.effectAllowed='none';
  ev.dataTransfer.setData("Text",this.name);
	// draginfo=this;
  console.log("dragStart",  ev.dataTransfer.getData("Text"))
  this.dragged=true;
},
dragIt: function(ev) {
 
},
allowDrop: function(ev){
  ev.preventDefault();
},
dragStop: function(ev){
	 //if (draginfo=="") return;
	 ev.preventDefault();
	 var data=ev.dataTransfer.getData("Text");
	 console.log("dragStop",ev,ev.target," data ",data );
	 var parent=this.parentNode

	 //parent.insertBefore(draginfo,this)
	// draginfo="";
	
	 //ev.target.appendChild(document.getElementById(data));
 },
 
 

});
</script>

</polymer-element>



<polymer-element name="r-primitive" attributes="value toto" noscript>
<template>
  <content></content>
</template>
</polymer-element>

<polymer-element name="r-simpleexp" attributes="operator openbracket closebracket javatype " noscript>
<template>
 <content></content>
</template>
</polymer-element>






<!-- The Rule File : normally loaded as part of an import  or via ajax and inserted  -->



<polymer-element name="nb-ruleset" >
<template>
  Here is the ruleset.
  <r-ruleset activatehigherpriorityrule="true" aliasname="Projet2aliasesen_US" effectivedate="Always" expirationdate="" groupingreason="" guid="RS13df7c0ae92x6cca" mainflowguid="" mainflowname="" name="TestRuleSet1" persistent="false" projectname="Projet2" type="SimpleRuleset" usesglobal="false" varaliasname="TestRuleSet1aliasesen_US" version="4">
  <r-variable assignable="false" guid="VARBL13df7c23130xd562c" name="DBNAME" type="java.lang.String">
  <r-simpleexp closebracket="0" javatype="java.lang.String" openbracket="0" operator="">
  <r-primitive value="MyDB"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="false" guid="VARBL13df7c2aeb0xa4869" name="REVNUM" type="int">
<r-simpleexp closebracket="0" javatype="int" openbracket="0" operator="">
<r-primitive value="1"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="false" guid="VARBL13df7d31056x8e7cc" name="TRUE" type="boolean">
<r-simpleexp closebracket="0" javatype="boolean" openbracket="0" operator="">
<r-primitive value="true"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7c354cfxf08c" name="ClientName" type="java.lang.String">
<r-simpleexp closebracket="0" javatype="java.lang.String" openbracket="0" operator="">
<r-reference class="com.fireflies.objects.Patient" method="getLastname" static="false"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7c41ccexdd903" name="ClientId" type="int">
<r-simpleexp closebracket="0" javatype="int" openbracket="0" operator="">
<r-primitive value="10"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7c44cb0x6caf8" name="ManagerName" type="java.lang.String">
<r-simpleexp closebracket="0" javatype="java.lang.Object" openbracket="0" operator="">
<r-reference class="com.yasutech.qrules.network.ConnUtil" method="onull" static="true"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7c4b356xe3cbc" name="ManagerId" type="int">
<r-simpleexp closebracket="0" javatype="int" openbracket="0" operator="">
<r-primitive value="0"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7cb27b0x47133" name="a" type="int">
<r-simpleexp closebracket="0" javatype="int" openbracket="0" operator="">
<r-primitive value="11"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7cb650exd8426" name="b" type="int">
<r-simpleexp closebracket="0" javatype="int" openbracket="0" operator="">
<r-primitive value="12"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7cc2c8ex894b" name="LastNotifTimeSinceEpoch" type="long">
<r-simpleexp closebracket="0" javatype="long" openbracket="0" operator="">
<r-primitive value="0"/>
</r-simpleexp>
</r-variable>
<r-variable assignable="true" guid="VARBL13df7cdbd37x49ac" name="TodayDayOfWeek" type="DayOfWeek">
<r-simpleexp closebracket="0" javatype="java.lang.String" openbracket="0" operator="">
<r-reference class="utils.FunctionsUtil" method="dayOfWeekAsString" static="true">
<r-argument name="Date" type="java.util.Date">
<r-simpleexp closebracket="0" javatype="java.util.Date" openbracket="0" operator="">
<r-reference class="utils.FunctionsUtil" method="today" static="true"/>
</r-simpleexp>
</r-argument>
</r-reference>
</r-simpleexp>
</r-variable>
</r-ruleset>

</template>
<script>
 Polymer('nb-ruleset', {
   ready: function() {
     console.log("nb-ruleset ready ");
     
   },
   enteredView: function() {
     console.log("nb-ruleset inserted");
   },
   fooSignal: function(e, detail, sender) {
     console.log("nb-ruleset got  fooSignal ",detail, sender.id);
   }
 });
</script>



</polymer-element>


<polymer-element name="dial-variable"    attributes="opened autoCloseDisabled nbstep">
<template>
 
	<!-- si un seul signal alors on peut laccrocher ainsi -->
  Name: {{my_variable.name}} is of type {{my_variable.type}} 

  <div id="host">
   <p>list of dial-simpleexp will be there</p>
 </div>

 <polymer-signals id="xx"	on-polymer-signal-temp="{{tempSignal}}"></polymer-signals>
 <polymer-signals id="xx-dialog-dialog" on-polymer-signal-dialog="{{dialogSignal}}"></polymer-signals>
 <polymer-overlay id="overlay" opened="{{opened}}" autoCloseDisabled="{{autoCloseDisabled}}"></polymer-overlay>
 <div class="dialogblock" >
  <template  find if="{{nbstep > 1}}"> <h2>  step {{step}}/ {{nbstep}} </h2></template>
  <content select="#Step{{step}}"></content>
  <br><br>
  <template  find if="{{step < nbstep}}">   <button  id="nextButton" on-click="{{clickedNext}}" >Next</button> </template>		
  <template  find if="{{step > 1}}">   <button  on-click="{{clickedPrev}}" >Prev</button> </template>			
  <template  find if="{{step == nbstep }}">   <button id="doneButton" on-click="{{done}}">OK</button>  </template>
  <button on-click="{{cancel}}" >Cancel</button> 
</div>
</template>		
<script>
  function getAncestorByTagName(element,aid){
   var t=element.parentNode;
   while (t.tagName != aid.toUpperCase() && t!=document.body)
     t=t.parentNode;
   return t;
 }
 function somethingCheck(source) {

	// When this condition is true we allow to go to next step
	var adial=getAncestorByTagName(source,"dial-variable");
	console.log("somethingCheck:", source,dial);
	var dial=document.querySelector(adial.id);
	if (source.value!= 'something') {
    if (["ZoneC", "ZoneB", "ZoneA", "Hors-Zones", "ZoneE", "ZoneD", "C3"].inArray(source.value)){
     
      console.log("do not allow access");
      dial.webkitShadowRoot.querySelector("#nextButton").disabled=true;
    } else {
      dial.webkitShadowRoot.querySelector("#nextButton").disabled=false;
    }
  }else {
    
   dial.webkitShadowRoot.querySelector("#nextButton").disabled=true;
   
 }
 dial.name=source.value;

}

Array.prototype.inArray = function(p_val) {
  return (this.indexOf(p_val) != -1);
}

function GetChar (event){
  var keyCode = ('which' in event) ? event.which : event.keyCode;
  if (keyCode==13) {
   var adial=getAncestorByTagName(event.target,"dial-variable");
   var dial=document.querySelector(adial.id);
   if (["ZoneC", "ZoneB", "ZoneA", "Hors-Zones", "ZoneE", "ZoneD", "C3"].inArray(event.target.value)){
	    // do not allow access
	    dial.webkitShadowRoot.querySelector("#nextButton").disabled=true;
   } else {
     dial.webkitShadowRoot.querySelector("#nextButton").disabled=false;
   }
 }
}
(function() {  
  var debug = true;
  Polymer('dial-variable', {
   step :1,
   nbstep:3,
   name:"unknown",
   my_variable:"",
   my_simpleexps:[],
   opened:false,

   enteredView: function() {
     this.$.overlay.target = this;
   },
   clickedNext: function() {
     this.step += 1;
   },
   dialogSignal: function() {
     this.toggle();
   },
   toggle: function() {
    this.$.overlay.toggle();
    
  },
  set_variable: function(that) {
   this.my_variable=that;
 },

	// Here we build the simpleexp part of the dialog
	set_simpleexps: function(sexps) {
   this.my_simpleexps=sexps;
   var t = document.querySelector("#g-simpleexps");
   var that=this
   var shadow = this.$.host.createShadowRoot();
   var model = {   salutations: { }  }
   t.model=model;

   for (var i=0 ; i< this.my_simpleexps.length; i++) {
    t.model.salutations.index = i;
    t.model.salutations.last = (i==this.my_simpleexps.length-1);
    fragment =  t.content.cloneNode(true)
    shadow.appendChild(fragment)
  }
  var els = shadow.querySelectorAll("dial-simpleexp");
  setTimeout(function() {
    for (var i=0 ; i< els.length; i++) {
      var varr= { index:i, last:true, sexp:that.my_simpleexps[i]};
      els[i].set_raw_value(varr)
    }
  });
  
},

clickedPrev: function() {
 this.step -= 1;
},
cancel: function() {
 this.toggle()
},
done: function() {
 this.toggle()
},

openedChanged: function() {
  if (this.opened) this.step=1;
}
});
})();
</script>
</polymer-element>




<!--  The templates used by the dialogs -->


<!-- note: -->
<!--  putting these templates (and changing the app accordingly) -->
<!--  within the elements does not work for  some reason -->



<nb-ruleset></nb-ruleset>	
<script>

 
</script>
</body>
</html>
